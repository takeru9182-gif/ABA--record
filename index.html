<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ABAè¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆè©¦ä½œç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1976d2;
      --primary-soft: #e3f2fd;
      --accent: #ffb300;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --danger: #e53935;
      --success: #43a047;
      --text-main: #222;
      --text-sub: #666;
      --border-soft: #e0e0e0;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text-main);
    }
    .app-container {
      max-width: 980px;
      margin: 0 auto;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 4px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 16px;
    }
    .chip-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px 16px 16px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
      border: 1px solid #e5e7eb;
    }
    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-title span.emoji {
      fontã‚µã‚¤ã‚º: 18px;
    }
    .card-description {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 8px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    input, select {
      width: 100%;
      padding: 6px 9px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #fafafa;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(25,118,210,0.12);
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1;
      min-width: 150px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 7px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-right: 8px;
      white-space: nowrap;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-outline {
      background: #fff;
      color: #1976d2;
      border: 1px solid #e3f2fd;
    }
    .btn-success {
      background: #43a047;
      color: white;
    }
    .btn-fail {
      background: #e53935;
      color: white;
    }
    .btn-save {
      background: #1976d2;
      color: white;
      width: 100%;
      margin-top: 10px;
      padding: 9px 14px;
      font-weight: 600;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
    }
    .btn-danger {
      background: #fff5f5;
      color: #e53935;
      border: 1px solid #ffcdd2;
    }
    .tags-inline {
      font-size: 12px;
      min-height: 20px;
      color: var(--text-sub);
    }
    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      background: #e3f2fd;
      color: #1976d2;
      margin: 2px;
    }
    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .session-list-item {
      border-bottom: 1px solid #f0f0f0;
      padding: 6px 0;
      font-size: 12px;
    }
    .session-meta {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 4px;
    }
    .session-main {
      margin-top: 2px;
      color: var(--text-sub);
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    .summary-table th, .summary-table td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: center;
    }
    .summary-table th {
      background: #fafafa;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: var(--text-sub);
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffb300;
    }
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .kpi-card {
      flex: 1;
      min-width: 130px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
    }
    .kpi-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }
    .kpi-value {
      font-size: 16px;
      font-weight: 600;
    }
    .kpi-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #eceff1;
      overflow: hidden;
      margin-top: 4px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #81c784);
      width: 0%;
      transition: width 0.2s ease-out;
    }
    @media (max-width: 640px) {
      .card { border-radius: 14px; padding: 12px 12px 14px; }
      .btn { margin-bottom: 4px; }
      .btn-save { margin-top: 8px; }
    }
  </style>
</head>
<body>

  <div class="app-container">
    <h1>ABAè¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆè©¦ä½œç‰ˆï¼‰</h1>
    <div class="subtitle">ABAç™‚è‚²ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã€ŒæˆåŠŸ / å¤±æ•—ã€ã‚’è¨˜éŒ²ã—ã€ç”Ÿå¾’ã”ã¨ã®æˆé•·ã‚’ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</div>

    <div class="chip-row">
      <div class="chip">âœ… 10ã€œ15ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚’ã‚µã‚¯ãƒƒã¨è¨˜éŒ²</div>
      <div class="chip">ğŸ“Š ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ã‚°ãƒ©ãƒ•</div>
      <div class="chip">ğŸ“ˆ ä¼¸ã³ï¼ˆæˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼‰ã‚‚è‡ªå‹•è¨ˆç®—</div>
    </div>

    <!-- â‘  ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ“š</span>
          <span>â‘  ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†</span>
        </div>
      </div>
      <div class="card-description">
        ã¾ãšã¯ã€è¨˜éŒ²å¯¾è±¡ã¨ãªã‚‹ã€Œç”Ÿå¾’ã€ã¨ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¡Œå‹•ï¼‰ã€ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
      </div>

      <div class="row">
        <div>
          <label>ç”Ÿå¾’åã®è¿½åŠ </label>
          <div class="row">
            <div style="flex:2;">
              <input id="newStudentName" placeholder="ä¾‹ï¼šAãã‚“">
            </div>
            <div style="flex:1; display:flex; align-items:center;">
              <button class="btn btn-outline" style="width:100%;" onclick="addStudent()">ç”Ÿå¾’ã‚’ç™»éŒ²</button>
            </div>
          </div>
        </div>
        <div>
          <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¡Œå‹•ï¼‰ã®è¿½åŠ </label>
          <div class="row">
            <div style="flex:2;">
              <input id="newSectionName" placeholder="ä¾‹ï¼šè¦æ±‚ã®è¡¨å‡º">
            </div>
            <div style="flex:1; display:flex; align-items:center;">
              <button class="btn btn-outline" style="width:100%;" onclick="addSection()">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>ç™»éŒ²æ¸ˆã¿ã®ç”Ÿå¾’</label>
          <div id="studentList" class="tags-inline"></div>
          <div class="row" style="margin-top:6px;">
            <div>
              <label style="font-size:11px;">ç”Ÿå¾’å‰Šé™¤ï¼ˆï¼‹è©²å½“ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰</label>
              <select id="deleteStudentSelect">
                <option value="">ç”Ÿå¾’ã‚’é¸æŠ</option>
              </select>
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button class="btn btn-small btn-danger" onclick="deleteStudentMaster()">ç”Ÿå¾’ã‚’å‰Šé™¤</button>
            </div>
          </div>
        </div>
        <div>
          <label>ç™»éŒ²æ¸ˆã¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
          <div id="sectionList" class="tags-inline"></div>
          <div class="row" style="margin-top:6px;">
            <div>
              <label style="font-size:11px;">ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆï¼‹è©²å½“ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰</label>
              <select id="deleteSectionSelect">
                <option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</option>
              </select>
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button class="btn btn-small btn-danger" onclick="deleteSectionMaster()">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â‘¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ² -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">âœï¸</span>
          <span>â‘¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²</span>
        </div>
        <div class="badge">
          <span class="badge-dot"></span>
          <span>ç¾å ´ã§ä½¿ã†ãƒ¡ã‚¤ãƒ³ç”»é¢</span>
        </div>
      </div>
      <div class="card-description">
        ç”Ÿå¾’ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸ã³ã€ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã”ã¨ã«ã€ŒæˆåŠŸ / å¤±æ•—ã€ã‚’æŠ¼ã—ã¦ã„ãã ã‘ã§è¨˜éŒ²ã§ãã¾ã™ã€‚
      </div>

      <div class="row">
        <div>
          <label>ç”Ÿå¾’ã‚’é¸æŠ</label>
          <select id="childSelect">
            <option value="">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div>
          <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</label>
          <select id="sectionSelect">
            <option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç›®æ¨™å›æ•°</label>
          <input id="trialGoal" type="number" value="10" min="1" max="30">
        </div>
        <div>
          <label>ç¾åœ¨ã®å›æ•°</label>
          <div id="trialCountDisplay" style="font-size:13px; font-weight:600;">0 å›</div>
        </div>
      </div>

      <label style="margin-top:10px;">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«å…¥åŠ›</label>
      <div class="row" style="margin-top:4px;">
        <div style="flex:1; min-width:120px;">
          <button class="btn btn-success" style="width:100%;" onclick="addTrial(true)">æˆåŠŸï¼ˆâ—¯ï¼‰</button>
        </div>
        <div style="flex:1; min-width:120px;">
          <button class="btn btn-fail" style="width:100%;" onclick="addTrial(false)">å¤±æ•—ï¼ˆâœ•ï¼‰</button>
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-label">ç¾åœ¨ã®æˆåŠŸç‡</div>
          <div class="kpi-value" id="kpiRate">0%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="kpiProgress"></div>
          </div>
          <div class="kpi-sub" id="kpiDetail">æˆåŠŸ 0 å› / 0 å›ä¸­</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çŠ¶æ³</div>
          <div class="kpi-value" id="kpiCount">0 / 0</div>
          <div class="kpi-sub">ç›®æ¨™å›æ•°ã«å¯¾ã™ã‚‹ç¾æ™‚ç‚¹ã®é€²ã¿å…·åˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
        </div>
      </div>

      <button class="btn btn-save" onclick="saveSession()">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜</button>
    </div>

    <!-- â‘¢ éå»ãƒ‡ãƒ¼ã‚¿ & ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ“‹</span>
          <span>â‘¢ éå»ãƒ‡ãƒ¼ã‚¿ & ãƒ•ã‚£ãƒ«ã‚¿</span>
        </div>
      </div>
      <div class="card-description">
        ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§çµã‚Šè¾¼ã‚“ã§ã€éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚„ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºãƒ»ãƒªã‚»ãƒƒãƒˆã§ãã¾ã™ã€‚
      </div>

      <div class="row">
        <div>
          <label>è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’</label>
          <select id="filterChild">
            <option value="">å…¨ã¦ã®ç”Ÿå¾’</option>
          </select>
        </div>
        <div>
          <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
          <select id="filterSection">
            <option value="">å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
        <button class="btn btn-small btn-primary" onclick="applyFilter()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ & ã‚°ãƒ©ãƒ•æ›´æ–°</button>
        <button class="btn btn-small btn-danger" onclick="deleteFilteredData()">ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
      </div>

      <h3 style="font-size:13px; margin-top:12px; margin-bottom:4px;">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§</h3>
      <div id="sessionList"></div>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ“ˆ</span>
          <span>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®æˆåŠŸç‡ã®æ¨ç§»</span>
        </div>
      </div>
      <div class="card-description">
        é¸æŠã—ãŸç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œ1å›ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã®æˆåŠŸç‡ã®å¤‰åŒ–ã§ã™ã€‚
      </div>
      <div id="currentGraphRate" style="font-size:12px; margin:0 0 4px 0; color:var(--text-main); font-weight:500;">
        æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸç‡ï¼š- %
      </div>
      <canvas id="sessionChart" height="210"></canvas>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ï¼šç”Ÿå¾’åˆ¥ã‚µãƒãƒªãƒ¼ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ§‘â€ğŸ“</span>
          <span>ç”Ÿå¾’åˆ¥ã‚µãƒãƒªãƒ¼</span>
        </div>
      </div>
      <div class="card-description">
        ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã€ç”Ÿå¾’ã”ã¨ã«ã¾ã¨ã‚ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
        å¹³å‡æˆåŠŸç‡ã¨ã€Œ1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šã®ä¼¸ã³ï¼ˆæˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼‰ã€ã‚’ç¢ºèªã§ãã¾ã™ã€‚
      </div>
      <canvas id="studentChart" height="220"></canvas>
      <div id="studentSummary"></div>
    </div>

  </div> <!-- /app-container -->

<script>
  let currentTrials = [];
  let sessions = [];
  let students = [];
  let sections = [];
  let sessionChart = null;
  let studentChart = null;

  const STORAGE_KEY_SESSIONS = "ABA_SESSIONS_V1";
  const STORAGE_KEY_STUDENTS = "ABA_STUDENTS_V1";
  const STORAGE_KEY_SECTIONS = "ABA_SECTIONS_V1";

  function loadFromStorage() {
    try {
      const rawSessions = localStorage.getItem(STORAGE_KEY_SESSIONS);
      sessions = rawSessions ? JSON.parse(rawSessions) : [];
    } catch (e) { sessions = []; }
    try {
      const rawStudents = localStorage.getItem(STORAGE_KEY_STUDENTS);
      students = rawStudents ? JSON.parse(rawStudents) : [];
    } catch (e) { students = []; }
    try {
      const rawSections = localStorage.getItem(STORAGE_KEY_SECTIONS);
      sections = rawSections ? JSON.parse(rawSections) : [];
    } catch (e) { sections = []; }
    cleanupOrphanSessions();
  }

  function saveSessionsToStorage() {
    localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions));
  }
  function saveStudentsToStorage() {
    localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(students));
  }
  function saveSectionsToStorage() {
    localStorage.setItem(STORAGE_KEY_SECTIONS, JSON.stringify(sections));
  }

  function cleanupOrphanSessions() {
    const validChildren = new Set(students);
    const validSections = new Set(sections);
    const before = sessions.length;
    sessions = sessions.filter(s => validChildren.has(s.child) && validSections.has(s.section));
    if (sessions.length !== before) {
      saveSessionsToStorage();
    }
  }

  function addStudent() {
    const name = document.getElementById("newStudentName").value.trim();
    if (!name) { alert("ç”Ÿå¾’åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    if (!students.includes(name)) {
      students.push(name);
      students.sort();
      saveStudentsToStorage();
      document.getElementById("newStudentName").value = "";
      renderStudentMaster();
      renderChildSelects();
    } else {
      alert("æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ç”Ÿå¾’ã§ã™ã€‚");
    }
  }

  function addSection() {
    const name = document.getElementById("newSectionName").value.trim();
    if (!name) { alert("ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    if (!sections.includes(name)) {
      sections.push(name);
      sections.sort();
      saveSectionsToStorage();
      document.getElementById("newSectionName").value = "";
      renderSectionMaster();
      renderSectionSelects();
    } else {
      alert("æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚");
    }
  }

  function deleteStudentMaster() {
    const name = document.getElementById("deleteStudentSelect").value;
    if (!name) { alert("å‰Šé™¤ã™ã‚‹ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    const count = sessions.filter(s => s.child === name).length;
    const ok = confirm(
      `ç”Ÿå¾’ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
ã“ã®ç”Ÿå¾’ã«ç´ã¥ãã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ ${count} ä»¶ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
    );
    if (!ok) return;

    students = students.filter(s => s !== name);
    saveStudentsToStorage();

    sessions = sessions.filter(s => s.child !== name);
    saveSessionsToStorage();

    cleanupOrphanSessions();

    renderStudentMaster();
    renderChildSelects();
    renderSessionList();
    updateSessionChart();
    updateStudentChart();

    document.getElementById("deleteStudentSelect").value = "";
    document.getElementById("childSelect").value = "";
    document.getElementById("filterChild").value = "";

    alert("ç”Ÿå¾’ã¨ã€ãã®ç”Ÿå¾’ã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  }

  function deleteSectionMaster() {
    const name = document.getElementById("deleteSectionSelect").value;
    if (!name) { alert("å‰Šé™¤ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    const count = sessions.filter(s => s.section === name).length;
    const ok = confirm(
      `ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç´ã¥ãã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ ${count} ä»¶ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
    );
    if (!ok) return;

    sections = sections.filter(s => s !== name);
    saveSectionsToStorage();

    sessions = sessions.filter(s => s.section !== name);
    saveSessionsToStorage();

    cleanupOrphanSessions();

    renderSectionMaster();
    renderSectionSelects();
    renderSessionList();
    updateSessionChart();
    updateStudentChart();

    document.getElementById("deleteSectionSelect").value = "";
    document.getElementById("sectionSelect").value = "";
    document.getElementById("filterSection").value = "";

    alert("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã€ãã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  }

  function renderStudentMaster() {
    const el = document.getElementById("studentList");
    if (students.length === 0) { el.textContent = "ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"; return; }
    el.innerHTML = students.map(s => `<span class="pill">${s}</span>`).join(" ");
  }

  function renderSectionMaster() {
    const el = document.getElementById("sectionList");
    if (sections.length === 0) { el.textContent = "ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"; return; }
    el.innerHTML = sections.map(s => `<span class="pill">${s}</span>`).join(" ");
  }

  function renderChildSelects() {
    const childSelect = document.getElementById("childSelect");
    const filterChild = document.getElementById("filterChild");
    const deleteStudentSelect = document.getElementById("deleteStudentSelect");

    childSelect.innerHTML = '<option value="">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    filterChild.innerHTML = '<option value="">å…¨ã¦ã®ç”Ÿå¾’</option>';
    deleteStudentSelect.innerHTML = '<option value="">ç”Ÿå¾’ã‚’é¸æŠ</option>';

    students.forEach(s => {
      const opt1 = document.createElement("option");
      opt1.value = s; opt1.textContent = s; childSelect.appendChild(opt1);
      const opt2 = document.createElement("option");
      opt2.value = s; opt2.textContent = s; filterChild.appendChild(opt2);
      const opt3 = document.createElement("option");
      opt3.value = s; opt3.textContent = s; deleteStudentSelect.appendChild(opt3);
    });
  }

  function renderSectionSelects() {
    const sectionSelect = document.getElementById("sectionSelect");
    const filterSection = document.getElementById("filterSection");
    const deleteSectionSelect = document.getElementById("deleteSectionSelect");

    sectionSelect.innerHTML = '<option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    filterSection.innerHTML = '<option value="">å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>';
    deleteSectionSelect.innerHTML = '<option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

    sections.forEach(s => {
      const opt1 = document.createElement("option");
      opt1.value = s; opt1.textContent = s; sectionSelect.appendChild(opt1);
      const opt2 = document.createElement("option");
      opt2.value = s; opt2.textContent = s; filterSection.appendChild(opt2);
      const opt3 = document.createElement("option");
      opt3.value = s; opt3.textContent = s; deleteSectionSelect.appendChild(opt3);
    });
  }

  function addTrial(isSuccess) {
    currentTrials.push(isSuccess);
    updateSessionStats();
  }

  function updateSessionStats() {
    const total = currentTrials.length;
    const success = currentTrials.filter(t => t).length;
    const rate = total === 0 ? 0 : Math.round((success / total) * 100);

    document.getElementById("trialCountDisplay").textContent = total + " å›";

    const kpiRate = document.getElementById("kpiRate");
    const kpiProgress = document.getElementById("kpiProgress");
    const kpiDetail = document.getElementById("kpiDetail");
    const kpiCount = document.getElementById("kpiCount");
    const goalRaw = document.getElementById("trialGoal").value;
    const goal = goalRaw ? parseInt(goalRaw, 10) : 0;

    kpiRate.textContent = rate + "%";
    kpiProgress.style.width = rate + "%";
    kpiDetail.textContent = `æˆåŠŸ ${success} å› / ${total} å›ä¸­`;

    if (goal > 0) {
      kpiCount.textContent = `${total} / ${goal}`;
    } else {
      kpiCount.textContent = `${total} / -`;
    }
  }

  function saveSession() {
    const child = document.getElementById("childSelect").value;
    const section = document.getElementById("sectionSelect").value;

    if (!child) { alert("ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    if (!section) { alert("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    if (currentTrials.length === 0) {
      alert("å°‘ãªãã¨ã‚‚1å›ã¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return;
    }

    const total = currentTrials.length;
    const success = currentTrials.filter(t => t).length;
    const rate = total === 0 ? 0 : Math.round((success / total) * 100);
    const now = new Date();

    const session = {
      id: Date.now(),
      child,
      section,
      total,
      success,
      rate,
      datetime: now.toISOString()
    };

    sessions.push(session);
    saveSessionsToStorage();
    currentTrials = [];
    updateSessionStats();
    document.getElementById("trialCountDisplay").textContent = "0 å›";

    renderSessionList();
    updateSessionChart();
    updateStudentChart();

    alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function applyFilter() {
    renderSessionList();
    updateSessionChart();
    updateStudentChart();
  }

  function getFilteredSessions() {
    const fChild = document.getElementById("filterChild").value;
    const fSection = document.getElementById("filterSection").value;

    return sessions.filter(s => {
      const childOk = fChild ? s.child === fChild : true;
      const sectOk = fSection ? s.section === fSection : true;
      return childOk && sectOk;
    }).sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
  }

  function deleteFilteredData() {
    const fChild = document.getElementById("filterChild").value;
    const fSection = document.getElementById("filterSection").value;

    if (!fChild && !fSection) {
      alert("å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€å°‘ãªãã¨ã‚‚ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const targetSessions = getFilteredSessions();
    if (targetSessions.length === 0) {
      alert("å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const conditionText = fSection
      ? `ç”Ÿå¾’ã€Œ${fChild}ã€Ã— ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œ${fSection}ã€`
      : `ç”Ÿå¾’ã€Œ${fChild}ã€ã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³`;

    const ok = confirm(
      conditionText + " ã®ãƒ‡ãƒ¼ã‚¿ã‚’ " +
      targetSessions.length + " ä»¶å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
    );
    if (!ok) return;

    sessions = sessions.filter(s => {
      const childMatch = fChild ? s.child === fChild : true;
      const sectMatch = fSection ? s.section === fSection : true;
      return !(childMatch && sectMatch);
    });

    saveSessionsToStorage();
    renderSessionList();
    updateSessionChart();
    updateStudentChart();
    alert("å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
  }

  function renderSessionList() {
    const listEl = document.getElementById("sessionList");
    const filtered = getFilteredSessions();

    if (filtered.length === 0) {
      listEl.innerHTML = "<div style='font-size:12px;color:#666;'>è©²å½“ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }

    listEl.innerHTML = "";
    filtered.forEach(s => {
      const d = new Date(s.datetime);
      const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;

      const div = document.createElement("div");
      div.className = "session-list-item";
      div.innerHTML = `
        <div class="session-meta">
          <div>
            <span class="tag">${s.child}</span>
            <span class="tag">${s.section}</span>
          </div>
          <div style="font-size:11px; color:#999;">${dateStr}</div>
        </div>
        <div class="session-main">
          æˆåŠŸ ${s.success} / ${s.total} å›ï¼ˆ${s.rate}%ï¼‰
        </div>
      `;
      listEl.appendChild(div);
    });
  }

  function updateSessionChart() {
    const ctx = document.getElementById("sessionChart").getContext("2d");
    const filtered = getFilteredSessions();

    const labels = filtered.map(s => {
      const d = new Date(s.datetime);
      return `${d.getMonth()+1}/${d.getDate()}`;
    });
    const data = filtered.map(s => s.rate);

    const currentLabel = document.getElementById("currentGraphRate");
    if (!filtered.length) {
      currentLabel.textContent = "æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸç‡ï¼š- %";
    } else {
      const lastRate = filtered[filtered.length - 1].rate;
      currentLabel.textContent = `æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸç‡ï¼š${lastRate}%`;
    }

    if (sessionChart) {
      sessionChart.destroy();
    }

    sessionChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "æˆåŠŸç‡ï¼ˆ%ï¼‰",
          data,
          fill: false,
          tension: 0.25
        }]
      },
      options: {
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: { stepSize: 20 }
          }
        }
      }
    });
  }

  function updateStudentChart() {
    const ctx = document.getElementById("studentChart").getContext("2d");
    const filtered = getFilteredSessions();

    const byChild = {};
    filtered.forEach(s => {
      if (!byChild[s.child]) byChild[s.child] = [];
      byChild[s.child].push(s);
    });

    const labels = [];
    const avgRates = [];
    const speeds = [];

    Object.keys(byChild).forEach(child => {
      const sess = byChild[child].sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
      const n = sess.length;
      const sum = sess.reduce((acc, cur) => acc + cur.rate, 0);
      const avg = n === 0 ? 0 : Math.round(sum / n);

      const first = sess[0].rate;
      const last = sess[n-1].rate;
      const delta = last - first;
      const speed = n > 1 ? (delta / (n-1)) : 0;

      labels.push(child);
      avgRates.push(avg);
      speeds.push(Math.round(speed * 10) / 10);
    });

    if (studentChart) {
      studentChart.destroy();
    }

    studentChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "å¹³å‡æˆåŠŸç‡ï¼ˆ%ï¼‰", data: avgRates },
          { label: "æˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆ1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šã®å¤‰åŒ–ï¼‰", data: speeds }
        ]
      },
      options: {
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: 100
          }
        }
      }
    });

    const summaryEl = document.getElementById("studentSummary");
    if (labels.length === 0) {
      summaryEl.innerHTML = "<div style='font-size:12px;color:#666;margin-top:8px;'>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }

    let html = '<table class="summary-table"><thead><tr><th>ç”Ÿå¾’</th><th>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</th><th>å¹³å‡æˆåŠŸç‡ï¼ˆ%ï¼‰</th><th>æœ€åˆã®æˆåŠŸç‡</th><th>æœ€æ–°ã®æˆåŠŸç‡</th><th>æˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰</th></tr></thead><tbody>';
    Object.keys(byChild).forEach((child, idx) => {
      const sess = byChild[child].sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
      const n = sess.length;
      const first = sess[0].rate;
      const last = sess[n-1].rate;
      const speed = speeds[idx];
      html += `<tr>
        <td>${child}</td>
        <td>${n}</td>
        <td>${avgRates[idx]}</td>
        <td>${first}</td>
        <td>${last}</td>
        <td>${speed}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    summaryEl.innerHTML = html;
  }

  loadFromStorage();
  renderStudentMaster();
  renderSectionMaster();
  renderChildSelects();
  renderSectionSelects();
  renderSessionList();
  updateSessionStats();
  updateSessionChart();
  updateStudentChart();
</script>

</body>
</html>
